<!DOCTYPE html>
<html lang="en">
<script src="data/level-data.js"></script>
<script src="data/word-relations.js"></script>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tamil Learning App</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f7fa;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .app{background:#fff;padding:20px;border-radius:14px;width:380px;box-shadow:0 10px 25px rgba(0,0,0,.1);text-align:center}
    .hidden{display:none}
    #flashCounter,#quizCounter,#exerciseCounter,#matchCounter{font-size:14px;color:#6b7280;margin-bottom:8px;text-align:right}
    #result h2{margin-bottom:10px}
    #result p{font-size:18px;margin-bottom:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px}

    /* MATCH UX */
    #match .grid{gap:12px}
    #matchLeft,#matchRight{display:flex;flex-direction:column;gap:10px}
    #matchLeft .opt,#matchRight .opt{width:100%;text-align:center;font-size:16px;padding:12px}
    #matchLeft .opt{background:#eef2ff}
    #matchRight .opt{background:#f0fdf4}
    #match .opt.correct{background:#bbf7d0 !important;animation:fadeOut 0.6s ease forwards}
    #match .opt.wrong{background:#fecaca !important;animation:shake 0.35s ease}

    .mode-grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:20px}
    .mode-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px;font-size:18px;border-radius:14px}
    .btn{padding:14px;border:none;border-radius:12px;color:#fff;font-size:16px;cursor:pointer}
    .animals{background:#4f46e5}.birds{background:#0284c7}.fruits{background:#16a34a}
    .verbs{background:#ca8a04}.household{background:#0f766e}.grocery{background:#7c3aed}
    .synonyms{background:#9333ea}.antonyms{background:#0ea5e9}
    .card{height:160px;background:#4f46e5;color:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;margin:12px 0}
    .inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s}
    .inner.flipped{transform:rotateY(180deg)}
    .side{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;align-items:center;justify-content:center}
    .back{background:#16a34a;transform:rotateY(180deg)}
    .options{display:flex;flex-direction:column;gap:10px;margin:14px 0}
    .opt{padding:10px;border-radius:8px;border:1px solid #c7d2fe;background:#eef2ff;color:#1f2937;font-size:15px;cursor:pointer}
    .correct{background:#bbf7d0;color:#065f46}
    .wrong{background:#fecaca;color:#7f1d1d}
    button{padding:8px 14px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer}

    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-6px)}
      100%{transform:translateX(0)}
    }

    @keyframes fadeOut{
      0%{opacity:1}
      100%{opacity:0.45}
    }
  
    .progress-cards{display:flex;flex-direction:column;gap:12px;margin-top:16px}
    .p-card{display:flex;gap:12px;align-items:center;padding:14px;border-radius:14px}
    .p-card h4{margin:0 0 4px 0}
    .p-card p{margin:2px 0;font-size:14px}
    .p-icon{font-size:28px}
    .p-card.quiz{background:#eef2ff}
    .p-card.exercise{background:#f0fdf4}
    .p-card.match{background:#fff7ed}
    .cat-progress{
      font-size:12px;
      margin-top:6px;
      opacity:.9;
    }
    .cat-progress span{
      display:block;
    }
    #resultCard{
      text-align:center;
    }

    .result-summary{
      text-align:left;
      margin:16px 0;
      line-height:1.6;
    }

    .result-summary .new-best{
      color:#16a34a;
      font-weight:bold;
    }

    .result-actions{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:20px;
    }
    #parentDashboard{
      color:#111;     
      text-align:left;
    }

    #parentDashboard h3{
      margin-top:16px;
    }

    .pd-card{
       color:#111;
      background:#f5f7fa;
      padding:12px;
      border-radius:10px;
      margin-bottom:10px;
    }
    .util-btn{
      padding:4px 10px;
      font-size:12px;
      border-radius:8px;
      background:#f1f5f9;
      color:#475569;
      border:1px solid #e2e8f0;
      cursor:pointer;
    }



  </style>
</head>
<body>
<div class="app">

  <!-- HOME -->
  <div id="home">
    <div style="text-align:center; margin-bottom:12px">
      <img
        src="logo-full.png"
        alt="Tamil Learning"
        style="height:42px"
      />
    </div>
    <!-- CURRENT PROFILE -->
    <div id="homeProfile" style="margin:8px 0;color:#374151;font-size:14px">
      üë§ <b id="currentProfileName"></b>
      <button onclick="changeProfile()" class="util-btn">Change</button>
      <button onclick="showParentDashboard()" class="util-btn">üë®‚Äçüë©‚Äçüëß Parent View</button>

    </div>
    <!-- LEVEL INDICATOR -->
    <div id="homeLevel"
        style="margin:6px 0;font-size:14px;color:#374151">
      Level:
      <b id="currentLevelLabel">‚≠ê Beginner</b>
      <button class="util-btn" onclick="openLevelSelector()">Change</button>      
    </div>

    <div style="font-size:13px;margin-top:4px" id="homePracticeToday">
            ‚ùå Not practiced today
    </div>
    <!-- HOME PROGRESS SUMMARY -->
    <div id="homeProgress"
        style="margin:10px 0;padding:10px;border-radius:12px;
                background:#f8fafc;color:#111827;text-align:left">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px">üî• <b><span id="homeStreak">0</span>-day streak</b></div>
          

          <div style="font-size:13px;margin-top:4px">
            ‚≠ê Best Quiz: <b><span id="homeBestQuiz">0</span></b>
          </div>
        </div>
        <button
          style="padding:6px 10px;border-radius:8px;background:#e5e7eb;color:#111827"
          onclick="openProgress()"
        >
          üìä View
        </button>
      </div>
    </div>

    <p>Select a category</p>
    <div class="grid">
      <button class="btn animals" onclick="selectCategory('animals')">
        üêæ Animals
         <div class="cat-progress" id="home-animals"></div>
      </button>
      <button class="btn birds" onclick="selectCategory('birds')">
        üê¶ Birds
         <div class="cat-progress" id="home-birds"></div>
      </button>
      <button class="btn fruits" onclick="selectCategory('fruits')">
        üçé Fruits
         <div class="cat-progress" id="home-fruits"></div>
      </button>
      <button class="btn verbs" onclick="selectCategory('verbs')">
        üèÉ Verbs
         <div class="cat-progress" id="home-verbs"></div>
      </button>
      <button class="btn household" onclick="selectCategory('household')">
        üè† Household
        <div class="cat-progress" id="home-household"></div>
      </button>
      <button class="btn grocery" onclick="selectCategory('grocery')">
        üõí Grocery
        <div class="cat-progress" id="home-grocery"></div>
      </button>
      <button class="btn synonyms" onclick="selectRelation('synonyms')">
        üîÅ Synonyms
      <div class="cat-progress" id="home-synonyms"></div>
      </button>
      <button class="btn antonyms" onclick="selectRelation('antonyms')">
        üîÄ Antonyms
      <div class="cat-progress" id="home-antonyms"></div>
      </button>
    </div>
  </div>

  <!-- MODE -->
  <div id="mode" class="hidden">
    <button onclick="goHome()">üè† Home</button>
    <h3 id="modeTitle"></h3>
    <p>Select learning mode</p>
    <div class="mode-grid">
      <button class="btn animals mode-btn" onclick="startFlashcards()">üÉè Flashcards</button>
      <button class="btn birds mode-btn" onclick="startQuiz()">üß† Quiz</button>
      <button class="btn fruits mode-btn" onclick="startExercise()">‚úèÔ∏è Fill in the Blanks</button>
      <button class="btn verbs mode-btn" onclick="startMatch()">üß© Match</button>
    </div>
  </div>

  <!-- FLASHCARDS -->
  <div id="flash" class="hidden">
    <div id="flashCounter"></div>
    <button onclick="goHome()">üè† Home</button>
    <div class="card" onclick="flipCard()">
      <div class="inner" id="cardInner">
        <div class="side" id="front"></div>
        <div class="side back" id="back"></div>
      </div>
    </div>
    <button onclick="prev()">Prev</button>
    <button onclick="next()">Next</button>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hidden">
    <div id="quizCounter"></div>
    <button onclick="goHome()">üè† Home</button>
    <h3 id="question"></h3>
    <div id="options" class="options"></div>
    <button id="quizNext" onclick="nextQuiz()" disabled>Next</button>
  </div>

  <!-- EXERCISE -->
  <div id="exercise" class="hidden">
    <div id="exerciseCounter"></div>
    <button onclick="goHome()">üè† Home</button>
    <h3 id="exerciseQuestion"></h3>
    <div id="exerciseOptions" class="options"></div>
    <button id="exerciseNext" onclick="nextExercise()" disabled>Next</button>
  </div>

  <!-- MATCH -->
  <div id="match" class="hidden">
    <div id="matchCounter"></div>
    <button onclick="goHome()">üè† Home</button>
    <div class="grid" style="margin-top:16px">
      <div id="matchLeft"></div>
      <div id="matchRight"></div>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden">
    <h2>üéâ Well Done!</h2>
    <p id="resultText"></p>
    <div class="mode-grid">
      <button class="btn fruits mode-btn" onclick="retryActivity()">üîÅ Retry</button>
      <button class="btn birds mode-btn" onclick="openProgress()">üìä Progress</button>
      <button class="btn animals mode-btn" onclick="goHome()">üè† Home</button>
    </div>
  </div>
<!-- RESULT CARD -->
  <div id="resultCard" class="hidden">
  <h2 id="resultTitle"></h2>

  <div class="result-summary" id="resultSummary"></div>

  <div class="result-actions">
    <button onclick="retryActivity()">üîÅ Retry</button>
    <button onclick="goHome()">üè† Home</button>
  </div>
</div>

    <!-- LEVEL SELECTOR -->
  <div id="levelSelector" class="hidden"
     style="position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:10000">
  <div style="background:#fff;padding:20px;border-radius:16px;
              width:280px;margin:20vh auto;text-align:center">
    <h3>Select Level</h3>
    <div id="levelOptions" style="margin-top:14px"></div>
    <button style="margin-top:12px" onclick="closeLevelSelector()">Cancel</button>
  </div>
</div>

  <!-- PROFILE -->
<div id="profile" class="hidden">
  <h2>üë§ Who is learning today?</h2>
  <input
    id="profileName"
    placeholder="Enter name"
    maxlength="12"
    style="padding:10px;width:90%;margin-top:12px;border-radius:10px;border:1px solid #c7d2fe;font-size:16px"
  />
  <div style="margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px;">
    <button
      class="btn animals mode-btn"
      onclick="confirmProfile()"
    >
      ‚ñ∂ Start Learning
    </button>

    <button
      class="util-btn"
      onclick="goHome()"
    >
      Cancel
    </button>
  </div>
</div>

  <!-- PROGRESS -->
  <div id="progress" class="hidden">
 <h2>üìä <span id="profileLabel"></span>‚Äôs Progress</h2>
  <p style="color:#6b7280;margin-top:-6px">Keep going! Every attempt makes you better ‚≠ê</p>
 <div class="p-card streak" style="background:#fff1f2">
  <div class="p-icon">üî•</div>
  <div>
    <h4>Daily Streak</h4>
    <p><b><span id="pStreak">0</span></b> days in a row</p>
  </div>
 </div>

  <div class="progress-cards">
    <div class="p-card quiz">
      <div class="p-icon">üß†</div>
      <div>
        <h4>Quiz</h4>
        <p>Attempts: <b><span id="pQuizAttempts">0</span></b></p>
        <p>Best Score: <b><span id="pQuizBest">0</span></b></p>
      </div>
    </div>

    <div class="p-card exercise">
      <div class="p-icon">‚úèÔ∏è</div>
      <div>
        <h4>Fill in the Blanks</h4>
        <p>Attempts: <b><span id="pExerciseAttempts">0</span></b></p>
        <p>Best Score: <b><span id="pExerciseBest">0</span></b></p>
      </div>
    </div>

    <div class="p-card match">
      <div class="p-icon">üß©</div>
      <div>
        <h4>Match</h4>
        <p>Attempts: <b><span id="pMatchAttempts">0</span></b></p>
      </div>
    </div>
  </div>

  <div class="mode-grid" style="margin-top:18px">
    <button class="btn birds mode-btn" onclick="changeProfile()">üë§ Change Profile</button>
    <button class="btn animals mode-btn" onclick="goHome()">üè† Home</button>
  </div>
</div>

 <!-- Parent Dashboard -->
  <div id="parentDashboard" class="hidden">
    <h2>üë®‚Äçüë©‚Äçüëß Parent Dashboard</h2>

    <div id="pdProfile"></div>
    <div id="pdOverall"></div>

    <h3 style="margin-top:20px">üìÇ Category Progress</h3>
    <div id="pdCategories"></div>

    <button onclick="goHome()">üè† Home</button>
  </div>

  
</div>

<script>
  function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

  
// ===== WORD RELATIONS DATA (20 WORDS) =====

  let currentCategory = null;
  let currentMode = null;
  const QUIZ_TOTAL = 20;
  const EXERCISE_TOTAL = 20;
  const LEVEL_CONFIG = {
  1: { quizOptions: 2, exerciseOptions: 2, matchOptions: 3 },
  2: { quizOptions: 3, exerciseOptions: 3, matchOptions: 5 },
  3: { quizOptions: 4, exerciseOptions: 4, matchOptions: 7 }
};


function getLevelConfig(){
  return LEVEL_CONFIG[getCurrentLevel()] || LEVEL_CONFIG[1];
}


  let list=[], i=0, score=0, exerciseIndex=0, exerciseOrder=[];

function getCurrentData(){
  const level = getCurrentLevel();
  return LEVEL_DATA[level] || LEVEL_DATA[1];
}
function categoryLabel(cat){
  return cat
    ? cat.charAt(0).toUpperCase() + cat.slice(1)
    : '';
}
function updateHomeCategoryProgress(){
  const p = getCategoryProgress();

  Object.keys(p).forEach(cat => {
    const el = document.getElementById(`home-${cat}`);
    if(!el) return;

    const data = p[cat];
    let lines = [];

    if(data.quiz?.attempts){
      lines.push(`üß† Best: ${data.quiz.best}`);
    }
    if(data.exercise?.attempts){
      lines.push(`‚úèÔ∏è Best: ${data.exercise.best}`);
    }
    if(data.match?.attempts){
      lines.push(`üß© Played: ${data.match.attempts}√ó`);
    }

    el.innerHTML = lines.map(l => `<span>${l}</span>`).join('');
  });
}


  function show(id){
    [
      'home',
      'mode',
      'flash',        // ‚úÖ ADD THIS
      'quiz',
      'exercise',
      'match',
      'progress',
      'resultCard',
      'parentDashboard',
      'profile' 
    ].forEach(v =>
      document.getElementById(v)?.classList.add('hidden')
    );

    document.getElementById(id).classList.remove('hidden');

    if(id === 'home'){
      updateHomeCategoryProgress();
    }
  }




  function goHome(){ show('home'); }

  window.onload = () => {
  if(getProfile()){
    show('home');
    updateHomeLevel();
    updateHomeProfile();
    updateHomeProgress();

  } else {
    show('profile');
  }
};


  function selectCategory(c){
    currentCategory = c; // ‚úÖ ADD THIS LINE
    //list = getCurrentData()[c].map(x=>{ const[t,e]=x.split('|'); return {ta:t,en:e}; });
    list = getCurrentData()[c].map(x => {
    if (typeof x === "string") {
      const [t, e] = x.split("|");
      return { ta: t, en: e };
    }
    return x; // already {ta,en,img}
  });

    i=0;
    modeTitle.textContent=c;
    show('mode');
  }
  function buildCategoryResultSummary({ category, mode, score, total, isNewBest }){
  const p = getCategoryProgress()[category];
  if(!p || !p[mode]) return '';

  let lines = [];

  lines.push(`üìÇ Category: ${categoryLabel(category)}`);

  if(mode !== 'match'){
    lines.push(`üéØ Score: ${score} / ${total}`);

    let bestLine = `üèÜ Best so far: ${p[mode].best} / ${total}`;
    if(isNewBest) bestLine += ' (New Best!)';
    lines.push(bestLine);
  }

  if(mode === 'match'){
    lines.push(`üîÅ Times practiced in this category: ${p.match.attempts}`);
  } else {
    lines.push(`üîÅ Attempts in this category: ${p[mode].attempts}`);
  }

  return lines.join('\n');
}


 function selectRelation(type){
  currentCategory = type; // 'synonyms' or 'antonyms'
  const level = getCurrentLevel();

  // get relations for current level, fallback to level 1
  const relations = WORD_RELATIONS[level] || WORD_RELATIONS[1];

  list = relations.map(w => {
    return {
      ta: w.ta,
      en: type === 'synonyms'
        ? w.synonyms.en[0]
        : w.antonyms.en[0]
    };
  });

  i = 0;
  modeTitle.textContent = type.toUpperCase();
  show('mode');
}


  function startFlashcards(){ show('flash'); updateCard(); }
  /*function updateCard(){ 
    front.textContent=list[i].ta; 
    back.textContent=list[i].en; 

    flashCounter.textContent=`${i+1} / ${list.length}`; 
  }*/
  function updateCard(){ 
    if(list[i].img){
      front.innerHTML = `
        <img src="${list[i].img}" style="height:80px;margin-bottom:8px"><br>
        ${list[i].ta}
      `;
    } else {
      front.textContent = list[i].ta;
    }
    back.textContent=list[i].en; 
    
    flashCounter.textContent=`${i+1} / ${list.length}`; 
  }
  
  function next(){ if(i<list.length-1){ i++; updateCard(); } }
  function prev(){ if(i>0){ i--; updateCard(); } }
  function flipCard(){ cardInner.classList.toggle('flipped'); }


  function startQuiz(){currentMode = 'quiz'; i=0; score=0; show('quiz'); loadQuiz(); }

  function loadQuiz(){
    const q=list[i];
    quizNext.disabled=true;
    quizNext.textContent='Next';
    question.textContent=q.ta;
    quizCounter.textContent=`${i+1} / ${list.length}`;
    options.innerHTML='';
    const { quizOptions } = getLevelConfig();
    let answered=false;
    const distractors=list.filter(x=>x.en!==q.en).map(x=>x.en);
    const choices=shuffle([q.en,...shuffle(distractors).slice(0,quizOptions - 1)]);
    choices.forEach(choice=>{
      const btn=document.createElement('button');
      btn.className='opt';
      btn.textContent=choice;
      btn.onclick=()=>{
        if(answered) return;
        answered=true;
        quizNext.disabled=false;
        document.querySelectorAll('#options .opt').forEach(b=>b.disabled=true);
        if(choice===q.en){ score++; btn.classList.add('correct'); }
        else{
          btn.classList.add('wrong');
          document.querySelectorAll('#options .opt').forEach(b=>{ if(b.textContent===q.en) b.classList.add('correct'); });
        }
        if(i===list.length-1) quizNext.textContent='Finish';
      };
      options.appendChild(btn);
    });
  }

  function nextQuiz(){
    if(quizNext.disabled) return;

    // LAST QUESTION
    if(i === list.length - 1){

      // 1Ô∏è‚É£ capture previous best
      const prevBest =
        getCategoryProgress()[currentCategory]?.quiz?.best || 0;

      // 2Ô∏è‚É£ record progress
      recordQuiz(score);

      // 3Ô∏è‚É£ detect new best
      const isNew = score > prevBest;

      // 4Ô∏è‚É£ streak + unlock
      updateStreak();
      checkLevelUnlock();

      // 5Ô∏è‚É£ show result summary
      showResultCard({
          title: 'üß† Quiz Completed!',
          summaryHtml: buildCategoryResultHTML({
            category: currentCategory,
            mode: 'quiz',
            score,
            total: list.length,
            isNewBest: isNew
          })
        });


      return;
    }

    // NEXT QUESTION
    i++;
    loadQuiz();
  }


  function startExercise(){currentMode = 'exercise'; exerciseIndex=0; score=0; exerciseOrder=shuffle([...list]); show('exercise'); loadExercise(); }

  function loadExercise(){
    const item=exerciseOrder[exerciseIndex];
    exerciseNext.disabled=true;
    exerciseNext.textContent='Next';
    exerciseQuestion.textContent=`${item.en} = _____`;
    exerciseCounter.textContent=`${exerciseIndex+1} / ${exerciseOrder.length}`;
    exerciseOptions.innerHTML='';
    let answered=false;
    // const distractors=list.filter(x=>x.ta!==item.ta).map(x=>x.ta);
    const allAnswers = list.map(x => x.ta);

    // remove correct answer ONCE
    const distractors = allAnswers.filter(ta => ta !== item.ta);

     const optionCount = getLevelConfig().exerciseOptions;

    const maxOptions = 1 + distractors.length;
    const optCount = Math.min(optionCount, maxOptions);
    const choices=shuffle([item.ta,...shuffle(distractors).slice(0,optCount - 1)]);
    choices.forEach(choice=>{
      const btn=document.createElement('button');
      btn.className='opt';
      btn.textContent=choice;
      btn.onclick=()=>{
        if(answered) return;
        answered=true;
        exerciseNext.disabled=false;
        document.querySelectorAll('#exerciseOptions .opt').forEach(b=>b.disabled=true);
        if(choice===item.ta){ score++; btn.classList.add('correct'); }
        else{
          btn.classList.add('wrong');
          document.querySelectorAll('#exerciseOptions .opt').forEach(b=>{ if(b.textContent===item.ta) b.classList.add('correct'); });
        }
        if(exerciseIndex===exerciseOrder.length-1) exerciseNext.textContent='Finish';
      };
      exerciseOptions.appendChild(btn);
    });
  }


 function nextExercise(){
    if(exerciseNext.disabled) return;

    // LAST QUESTION
    if(exerciseIndex === exerciseOrder.length - 1){

      // 1Ô∏è‚É£ capture previous best
      const prevBest =
        getCategoryProgress()[currentCategory]?.exercise?.best || 0;

      // 2Ô∏è‚É£ record progress
      recordExercise(score);

      // 3Ô∏è‚É£ detect new best
      const isNew = score > prevBest;

      // 4Ô∏è‚É£ streak + unlock
      updateStreak();
      checkLevelUnlock();

      // 5Ô∏è‚É£ show result summary
      showResultCard({
        title: '‚úèÔ∏è Fill in the Blanks Completed!',
        summaryHtml: buildCategoryResultHTML({
          category: currentCategory,
          mode: 'exercise',
          score,
          total: exerciseOrder.length,
          isNewBest: isNew
        })
      });


      return;
    }

    // NEXT QUESTION
    exerciseIndex++;
    loadExercise();
  }


  function showResult(){ resultText.textContent=`Your score: ${score} / ${list.length}`; show('result'); }

  // MATCH
  let matchPairs=[], selectedLeft=null, selectedRight=null, matchedCount=0;

  function startMatch(){
    currentMode = 'match';
    console.log('START MATCH ‚Üí list length:', list.length);
    matchedCount=0;
    selectedLeft=null; selectedRight=null;
    //matchPairs=shuffle([...list]).slice(0,4);
    const { matchOptions } = getLevelConfig();

    const maxPairs = Math.floor(list.length);
    const pairCount = Math.min(matchOptions, maxPairs);

    matchPairs = shuffle(list).slice(0, pairCount);

    matchLeft.innerHTML=''; matchRight.innerHTML='';
    matchCounter.textContent=`0 / ${matchPairs.length}`;
    matchPairs.forEach(pair=>{
      const l=document.createElement('button'); l.className='opt'; l.textContent=pair.ta; l.onclick=()=>selectLeft(pair,l); matchLeft.appendChild(l);
    });
    shuffle(matchPairs).forEach(pair=>{
      const r=document.createElement('button'); r.className='opt'; r.textContent=pair.en; r.onclick=()=>selectRight(pair,r); matchRight.appendChild(r);
    });
    show('match');
  }

  function selectLeft(pair,btn){ if(btn.disabled) return; clearSelection('left'); selectedLeft={pair,btn}; btn.classList.add('correct'); checkMatch(); }
  function selectRight(pair,btn){ if(btn.disabled) return; clearSelection('right'); selectedRight={pair,btn}; btn.classList.add('correct'); checkMatch(); }

  function clearSelection(side){
    document.querySelectorAll(side==='left'?'#matchLeft .opt':'#matchRight .opt').forEach(b=>b.classList.remove('correct','wrong'));
  }

 function checkMatch(){
  if(!selectedLeft || !selectedRight) return;

  if(selectedLeft.pair.en === selectedRight.pair.en){

    selectedLeft.btn.disabled = true;
    selectedRight.btn.disabled = true;

    matchedCount++;
    matchCounter.textContent = `${matchedCount} / ${matchPairs.length}`;

    selectedLeft = null;
    selectedRight = null;

    // üéØ MATCH COMPLETE
    if(matchedCount === matchPairs.length){

      // 1Ô∏è‚É£ record progress
      recordMatch();

      // 2Ô∏è‚É£ streak + unlock
      updateStreak();
      checkLevelUnlock();

      // 3Ô∏è‚É£ show category summary
     showResultCard({
        title: 'üß© Match Completed!',
        summaryHtml: buildCategoryResultHTML({
          category: currentCategory,
          mode: 'match'
        })
      });

    }

  } else {

    selectedLeft.btn.classList.add('wrong');
    selectedRight.btn.classList.add('wrong');

    setTimeout(() => {
      selectedLeft.btn.classList.remove('wrong','correct');
      selectedRight.btn.classList.remove('wrong','correct');
      selectedLeft = null;
      selectedRight = null;
    }, 600);
  }
}


function retryActivity(){
  if(currentMode === 'quiz') startQuiz();
  else if(currentMode === 'exercise') startExercise();
  else if(currentMode === 'match') startMatch();
}
/* ===== PROFILE MANAGEMENT ===== */

  function confirmProfile(){
  const input = document.getElementById('profileName');
  const name = input.value.trim();

  if(!/^[a-zA-Z]{2,12}$/.test(name)){
    alert('Please enter a valid name (2‚Äì12 letters)');
    return;
  }

  setProfile(name);
  show('home');
  updateHomeProfile();
  updateHomeProgress();

}

function changeProfile(){
  show('profile');
  document.getElementById('profileName').value = '';
}

function updateHomeProfile(){
  const el = document.getElementById('currentProfileName');
  if(el){
    el.textContent = formatProfileName(getProfile());

  }
}
function formatProfileName(name){
  if(!name) return '';
  return name.charAt(0).toUpperCase() + name.slice(1);
}

function levelKey(){
  return `tamil_level_${getProfile()}`;
}

function getLevelState(){
  const raw = localStorage.getItem(levelKey());
  if(raw) return JSON.parse(raw);

  // default for new profile
  const state = { current: 1, unlocked: [1] };
  localStorage.setItem(levelKey(), JSON.stringify(state));
  return state;
}

function saveLevelState(state){
  localStorage.setItem(levelKey(), JSON.stringify(state));
}

function getCurrentLevel(){
  return getLevelState().current;
}

function setCurrentLevel(level){
  const state = getLevelState();
  if(state.unlocked.includes(level)){
    state.current = level;
    saveLevelState(state);
  }
}

function isLevelUnlocked(level){
  return getLevelState().unlocked.includes(level);
}

function checkLevelUnlock(){
  const progress = getProgress();
  const levelState = getLevelState();
  const current = levelState.current;
  const nextLevel = current + 1;

  // Already unlocked ‚Üí nothing to do
  if(levelState.unlocked.includes(nextLevel)) return false;

  // Practice checks
  if(progress.quiz.attempts < 2) return false;
  if(progress.exercise.attempts < 2) return false;
  if(progress.match.attempts < 1) return false;

  // Mastery checks
  const quizPercent = percent(progress.quiz.best, QUIZ_TOTAL);
  const exercisePercent = percent(progress.exercise.best, EXERCISE_TOTAL);

  if(quizPercent < 70) return false;
  if(exercisePercent < 70) return false;

  // Consistency check
  if(!progress.streak || progress.streak.count < 3) return false;

  // ‚úÖ Unlock next level
  levelState.unlocked.push(nextLevel);
  saveLevelState(levelState);
  showLevelUnlocked(nextLevel);

  return true; // unlocked now
}

function showLevelUnlocked(level){
  const box = document.createElement('div');
  box.innerHTML = `
    üéâ <b>Level ${level} Unlocked!</b><br>
    You can switch levels anytime from Home.
  `;
  box.style.position = 'fixed';
  box.style.top = '50%';
  box.style.left = '50%';
  box.style.transform = 'translate(-50%, -50%)';
  box.style.background = '#ecfeff';
  box.style.color = '#0f172a';
  box.style.padding = '18px 22px';
  box.style.borderRadius = '14px';
  box.style.textAlign = 'center';
  box.style.boxShadow = '0 10px 30px rgba(0,0,0,.2)';
  box.style.zIndex = '10000';

  document.body.appendChild(box);

  setTimeout(() => box.remove(), 2500);
}
function levelName(level){
  if(level === 1) return '‚≠ê Beginner';
  if(level === 2) return '‚≠ê‚≠ê Intermediate';
  if(level === 3) return '‚≠ê‚≠ê‚≠ê Advanced';
  return `Level ${level}`;
}
function updateHomeLevel(){
  document.getElementById('currentLevelLabel')
    .textContent = levelName(getCurrentLevel());
}

function openLevelSelector(){
  const state = getLevelState();
  const box = document.getElementById('levelOptions');
  box.innerHTML = '';

  state.unlocked.forEach(level => {
    const btn = document.createElement('button');
    btn.textContent = levelName(level);
    btn.style.display = 'block';
    btn.style.width = '100%';
    btn.style.margin = '8px 0';
    btn.onclick = () => {
      setCurrentLevel(level);
      updateHomeLevel();
      closeLevelSelector();
    };
    box.appendChild(btn);
  });

  document.getElementById('levelSelector').classList.remove('hidden');
}

function closeLevelSelector(){
  document.getElementById('levelSelector').classList.add('hidden');
}

function showParentDashboard(){
  const profile = getProfile();
  const progress = getProgress();
  const catProgress = getCategoryProgress();

  // Profile section
  document.getElementById('pdProfile').innerHTML = `
    <div class="pd-card">
      <b>Name:</b> ${profile}<br>
      <b>Current Level:</b> ${getCurrentLevel()}<br>
      <b>Daily Streak:</b>  ${progress.streak?.count || 0} days
    </div>
  `;

  // Overall progress
  document.getElementById('pdOverall').innerHTML = `
    <div class="pd-card">
      üß† Quiz attempts: ${progress.quiz.attempts}<br>
      ‚úèÔ∏è Fill attempts: ${progress.exercise.attempts}<br>
      üß© Match plays: ${progress.match.attempts}
    </div>
  `;

  // Category breakdown
  const catEl = document.getElementById('pdCategories');
  catEl.innerHTML = '';

  Object.keys(catProgress).forEach(cat => {
    const c = catProgress[cat];
    catEl.innerHTML += `
      <div class="pd-card">
        <b>${categoryLabel(cat)}</b><br>
        üß† Quiz: ${c.quiz?.attempts || 0} | Best ${c.quiz?.best || '-'}<br>
        ‚úèÔ∏è Fill: ${c.exercise?.attempts || 0} | Best ${c.exercise?.best || '-'}<br>
        üß© Match: ${c.match?.attempts || 0}
      </div>
    `;
  });

  show('parentDashboard');
}

function showResultCard({ title, summaryHtml }){
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultSummary').innerHTML = summaryHtml;
  show('resultCard');
}
function buildCategoryResultHTML({ category, mode, score, total, isNewBest }){
  const p = getCategoryProgress()[category];
  if(!p || !p[mode]) return '';

  let html = `<p>üìÇ <b>Category:</b> ${categoryLabel(category)}</p>`;

  if(mode !== 'match'){
    html += `<p>üéØ <b>Score:</b> ${score} / ${total}</p>`;
    html += `<p>üèÜ <b>Best:</b> ${p[mode].best} / ${total}`;
    if(isNewBest) html += ` <span class="new-best">(New Best!)</span>`;
    html += `</p>`;
  }

  html += `<p>üîÅ <b>Attempts:</b> ${
    mode === 'match' ? p.match.attempts : p[mode].attempts
  }</p>`;

  return html;
}

  /* ===== PROGRESS TRACKING (GLOBAL) ===== */
const PROGRESS_KEY = () => `tamil_progress_${getProfile()}`;


function getProgress(){
  return JSON.parse(localStorage.getItem(PROGRESS_KEY())) || {
    quiz:{attempts:0,best:0},
    exercise:{attempts:0,best:0},
    match:{attempts:0}
  };
}

function saveProgress(p){
  localStorage.setItem(PROGRESS_KEY(), JSON.stringify(p));
}

function categoryProgressKey(){
  return `tamil_category_progress_${getProfile()}`;
}

function getCategoryProgress(){
  return JSON.parse(localStorage.getItem(categoryProgressKey())) || {};
}

function saveCategoryProgress(p){
  localStorage.setItem(categoryProgressKey(), JSON.stringify(p));
}

function percent(score, total){
  if(total === 0) return 0;
  return Math.round((score / total) * 100);
}

function today(){
  return new Date().toISOString().slice(0,10); // YYYY-MM-DD
}

function daysBetween(d1, d2){
  return Math.floor(
    (new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24)
  );
}

function practicedToday(){
  const p = getProgress();
  if(!p.streak || !p.streak.lastDate) return false;
  return p.streak.lastDate === today();
}


function updateHomeProgress(){
  const p = getProgress();

  document.getElementById('homeStreak').textContent =
    p.streak ? p.streak.count : 0;

  document.getElementById('homeBestQuiz').textContent =
    p.quiz ? p.quiz.best : 0;

  const practicedEl = document.getElementById('homePracticeToday');
  if(practicedToday()){
    practicedEl.textContent = '‚úÖ Practiced today';
    practicedEl.style.color = '#166534'; // green
  } else {
    practicedEl.textContent = '‚ùå Not practiced today';
    practicedEl.style.color = '#7f1d1d'; // red
  }
}



function updateStreak(){
  const p = getProgress();
  const t = today();

  if(!p.streak){
    p.streak = { count: 1, lastDate: t };
  } else {
    const diff = daysBetween(p.streak.lastDate, t);

    if(diff === 1){
      p.streak.count++;
      p.streak.lastDate = t;
    } else if(diff > 1){
      p.streak.count = 1;
      p.streak.lastDate = t;
    }
    // diff === 0 ‚Üí same day, do nothing
  }

  saveProgress(p);
}

function isNewBest(type, score){
  const p = getProgress();
  return score > (p[type]?.best || 0);
}

function showNewBest(){
  const msg = document.createElement('div');
  msg.textContent = '‚≠ê New Best!';
  msg.style.position = 'fixed';
  msg.style.top = '20px';
  msg.style.left = '50%';
  msg.style.transform = 'translateX(-50%)';
  msg.style.background = '#fde047';
  msg.style.color = '#713f12';
  msg.style.padding = '10px 16px';
  msg.style.borderRadius = '12px';
  msg.style.fontWeight = 'bold';
  msg.style.zIndex = '9999';
  msg.style.boxShadow = '0 6px 18px rgba(0,0,0,.15)';

  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}


function recordQuiz(score){
  const p = getProgress();
  p.quiz.attempts++;
  p.quiz.best = Math.max(p.quiz.best, score);
  const cp = getCategoryProgress();
  const cc = currentCategory;

  cp[cc] ??= { quiz:{attempts:0,best:0}, exercise:{attempts:0,best:0}, match:{attempts:0} };

  cp[cc].quiz.attempts++;
  cp[cc].quiz.best = Math.max(cp[cc].quiz.best, score);

  saveCategoryProgress(cp);
  saveProgress(p);
}

function recordExercise(score){
  const gp = getProgress();
  gp.exercise.attempts++;
  gp.exercise.best = Math.max(gp.exercise.best, score);
  const p = getCategoryProgress();
  const c = currentCategory;

  p[c] ??= { quiz:{attempts:0,best:0}, exercise:{attempts:0,best:0}, match:{attempts:0} };

  p[c].exercise.attempts++;
  p[c].exercise.best = Math.max(p[c].exercise.best, score);

  saveCategoryProgress(p);
  saveProgress(gp);
}

function recordMatch(){
  const gp = getProgress();
  gp.match.attempts++;
  const p = getCategoryProgress();
  const c = currentCategory;

  p[c] ??= { quiz:{attempts:0,best:0}, exercise:{attempts:0,best:0}, match:{attempts:0} };

  p[c].match.attempts++;

  saveCategoryProgress(p);
  saveProgress(gp);
}

/* ===== PROFILE ===== */
let currentProfile = localStorage.getItem('tamil_current_profile');

function setProfile(name){
  currentProfile = name.toLowerCase();
  localStorage.setItem('tamil_current_profile', currentProfile);
}

function getProfile(){
  return currentProfile;
}

function openProgress(){
  document.getElementById('profileLabel').textContent = getProfile();

  const p = getProgress();
  const s = p.streak ? p.streak.count : 0;
  document.getElementById('pStreak').textContent = s;

  document.getElementById('pQuizAttempts').textContent = p.quiz.attempts;
  document.getElementById('pQuizBest').textContent = p.quiz.best;

  document.getElementById('pExerciseAttempts').textContent = p.exercise.attempts;
  document.getElementById('pExerciseBest').textContent = p.exercise.best;

  document.getElementById('pMatchAttempts').textContent = p.match.attempts;

  show('progress');
  updateHomeProgress();
}

  console.assert(typeof selectCategory==='function','selectCategory exists');
</script>
</body>
</html>
